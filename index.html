<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord GNSS/IMU (V12.0 - EKF, Astro TST & IMU)</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="leaflet.css" />
    <style>
        /* Styles CSS pour la structure rapide, √† externaliser dans style.css */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a2e; color: #e9e9f2; margin: 0; padding: 20px; }
        .dashboard-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 1400px; margin: 0 auto; }
        .data-block { background-color: #1f4068; border-radius: 8px; padding: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); }
        h2 { color: #8d93ab; border-bottom: 2px solid #2e5984; padding-bottom: 5px; margin-top: 0; font-size: 1.2em; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95em; }
        .label { color: #b8c2cc; }
        .value { font-weight: bold; color: #ffffff; }
        .data-block.full-width { grid-column: 1 / -1; }
        #map { height: 300px; border-radius: 8px; margin-top: 10px; background-color: #24294d; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .controls button, .controls select { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #toggle-gps-btn { background-color: #4CAF50; color: white; }
        #emergency-stop-btn { background-color: #f44336; color: white; }
        #emergency-stop-btn.active { background-color: #cc0000; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { box-shadow: 0 0 5px #f44336; } to { box-shadow: 0 0 20px #f44336; } }
        /* Style pour les inputs */
        .controls-input { display: flex; align-items: center; gap: 5px; background-color: #2e5984; border-radius: 5px; padding: 5px; }
        .controls-input label { margin-right: 5px; color: #b8c2cc; }
        .controls-input input { border: none; padding: 4px; border-radius: 3px; width: 60px; text-align: right; background-color: #1f4068; color: white; }
    </style>
</head>
<body>

    <header>
        <h1>Tableau de Bord GNSS/IMU (V12.0 - Vitesse 3D, Astro TST)</h1>
    </header>

    <div class="dashboard-container">

        <div class="data-block">
            <h2>‚öôÔ∏è Contr√¥les & Syst√®me</h2>
            <div class="controls">
                <button id="toggle-gps-btn">‚ñ∂Ô∏è MARCHE GPS</button>
                <select id="freq-select">
                    <option value="HIGH_FREQ">Haute Fr√©quence</option>
                    <option value="LOW_FREQ">Basse Fr√©quence</option>
                </select>
                <button id="emergency-stop-btn">üõë Arr√™t d'urgence: INACTIF üü¢</button>
                <button id="nether-toggle-btn">üî• Mode Nether</button>
                <button id="capture-btn">üì∏ Capture</button>
            </div>
            <div class="data-row"><span class="label">Heure UTC (Synchro)</span><span class="value" id="local-time">Synchronisation...</span></div>
            <div class="data-row"><span class="label">Date Locale</span><span class="value" id="date-display">N/A</span></div>
            <div class="data-row"><span class="label">Temps √©coul√© (Session)</span><span class="value" id="time-elapsed">0.00 s</span></div>
            <div class="data-row"><span class="label">Temps de Mouvement</span><span class="value" id="time-moving">0.00 s</span></div>
            <div class="data-row"><span class="label">Heure Minecraft</span><span class="value" id="time-minecraft">00:00:00</span></div>
            <div class="data-row"><span class="label">Mode Nether (1:8)</span><span class="value" id="mode-nether">D√âSACTIV√â (1:1)</span></div>

            <hr style="border-top: 1px solid #2e5984; margin: 10px 0;">
            <div class="controls" style="justify-content: space-around;">
                <button id="reset-dist-btn" style="background-color: #e67e22;">‚ùå Distance & Temps</button>
                <button id="reset-max-btn" style="background-color: #9b59b6;">‚ùå Vitesse Max</button>
                <button id="reset-all-btn" style="background-color: #c0392b;">‚ö†Ô∏è TOUT R√âINITIALISER</button>
            </div>
        </div>

        <div class="data-block">
            <h2>üöÄ Vitesse & Distance</h2>
            <div class="data-row"><span class="label">Vitesse Stable (EKF 3D)</span><span class="value" id="speed-stable">NaN km/h</span></div>
            <div class="data-row"><span class="label">Vitesse Stable (m/s | mm/s)</span><span class="value" id="speed-stable-ms">NaN m/s | NaN mm/s</span></div>
            <div class="data-row"><span class="label">Pr√©cision EKF (R dyn.)</span><span class="value" id="speed-error-perc">N/A</span></div>
            <div class="data-row"><span class="label">Vitesse Max (Session)</span><span class="value" id="speed-max">0.00000 km/h</span></div>
            <div class="data-row"><span class="label">Vitesse Moyenne (Mvt)</span><span class="value" id="speed-avg-moving">0.00000 km/h</span></div>
            <hr style="border-top: 1px solid #2e5984; margin: 10px 0;">
            <div class="data-row"><span class="label">Distance Totale</span><span class="value" id="distance-total-km">NaN km | NaN m</span></div>
            <div class="data-row"><span class="label">Distance Cosmique</span><span class="value" id="distance-cosmic">NaN s lumi√®re | NaN al</span></div>
            <hr style="border-top: 1px solid #2e5984; margin: 10px 0;">
            <div class="data-row"><span class="label">Vitesse 3D (Brut)</span><span class="value" id="speed-3d-inst">NaN km/h</span></div>
            <div class="data-row"><span class="label">% Vitesse du Son</span><span class="value" id="perc-speed-sound">NaN %</span></div>
            <div class="data-row"><span class="label">% Vitesse de la Lumi√®re (c)</span><span class="value" id="perc-speed-c">NaN%</span></div>
        </div>

        <div class="data-block">
            <h2>üõ∞Ô∏è Vue brute GPS & M√©t√©o</h2>
            <div class="data-row"><span class="label">Latitude</span><span class="value" id="latitude">N/A</span></div>
            <div class="data-row"><span class="label">Longitude</span><span class="value" id="longitude">N/A</span></div>
            <div class="data-row"><span class="label">Altitude (MSL - EKF)</span><span class="value" id="altitude-gps">NaN m (EKF)</span></div>
            <div class="data-row"><span class="label">Vitesse Verticale (EKF)</span><span class="value" id="vertical-speed">NaN m/s (EKF)</span></div>
            <div class="data-row"><span class="label">Pr√©cision GPS (EPE)</span><span class="value" id="gps-precision">N/A</span></div>
            <div class="data-row"><span class="label">Sous-sol (Seuil -50m)</span><span class="value" id="underground-status">Non</span></div>
            <hr style="border-top: 1px solid #2e5984; margin: 10px 0;">
            <h2>üéöÔ∏è M√©t√©o & Capteurs</h2>
            <div class="data-row"><span class="label">Facteur Kalman Environnement</span>
                 <span class="value" id="env-factor">NORMAL</span>
            </div>
            <div class="data-row"><span class="label">Temp√©rature Air</span><span class="value" id="temp-air">N/A</span></div>
            <div class="data-row"><span class="label">Pression Atmosph√©rique</span><span class="value" id="pressure">N/A</span></div>
            <div class="data-row"><span class="label">Humidit√© Relative</span><span class="value" id="humidity">N/A</span></div>
        </div>
        
        <div class="data-block">
            <h2>‚öôÔ∏è Dynamique du V√©hicule (Masse: <span id="mass-display">70.000</span> kg)</h2>
            <div class="controls-input">
                <label for="mass-input">Masse (kg)</label>
                <input type="number" id="mass-input" value="70.000" step="0.001">
            </div>
            <p style="font-size: 0.8em; color: #ffcc00;">‚ö†Ô∏è Si capteurs IMU (DeviceMotion) non d√©marr√©s, valeurs brutes.</p>
            
            <div class="data-row"><span class="label">Acc√©l√©ration Longitudinale (IMU)</span><span class="value" id="accel-long-imu">NaN m/s¬≤</span></div>
            <div class="data-row"><span class="label">Acc√©l√©ration Lat√©rale (IMU)</span><span class="value" id="accel-lateral-imu">NaN m/s¬≤</span></div>
            <div class="data-row"><span class="label">Force Lat√©rale (Centrifuge - N)</span><span class="value" id="force-centrifugal-n">0.00 N</span></div>
            <div class="data-row"><span class="label">Force Lat√©rale (en G)</span><span class="value" id="force-g-lateral">0.00 G</span></div>

            <hr style="border-top: 1px solid #2e5984; margin: 10px 0;">
            <h2>‚òÄÔ∏è Soleil (√âph√©m√©rides SunCalc)</h2>
            <div class="data-row"><span class="label">Heure Solaire Vraie (TST)</span><span class="value" id="time-solar-true">N/A</span></div>
            <div class="data-row"><span class="label">Temps Solaire Moyen Local (LSM)</span><span class="value" id="culmination-lsm">N/A</span></div>
            <div class="data-row"><span class="label">Lever / Coucher Soleil (TST)</span><span class="value" id="sun-times-tst">N/A</span></div>
            <div class="data-row"><span class="label">√âl√©vation du Soleil</span><span class="value" id="sun-elevation">N/A</span></div>
            <div class="data-row"><span class="label">Azimut Solaire</span><span class="value" id="sun-azimuth">N/A</span></div>
            <div class="data-row"><span class="label">Dur√©e du Jour Solaire</span><span class="value" id="day-duration">N/A</span></div>
            <div class="data-row"><span class="label">√âquation du Temps (EOT)</span><span class="value" id="eot-min">N/A</span></div>
            <div class="data-row"><span class="label">Longitude √©cliptique</span><span class="value" id="ecliptic-long">N/A</span></div>
        </div>

        <div class="data-block">
            <h2>üåô Lune (SunCalc)</h2>
            <div class="data-row"><span class="label">Phase Lunaire (Fraction)</span><span class="value" id="lunar-phase-perc">N/A</span></div>
            <div class="data-row"><span class="label">Lever / Coucher Lune (TST)</span><span class="value" id="moon-culmination-tst">N/A</span></div>
            <div class="data-row"><span class="label">√âl√©vation Lunaire</span><span class="value" id="moon-elevation">N/A</span></div>
            <div class="data-row"><span class="label">Azimut Lunaire</span><span class="value" id="moon-azimuth">N/A</span></div>
            
            <hr style="border-top: 1px solid #2e5984; margin: 10px 0;">
            <h2>üó∫Ô∏è Carte GNSS (Leaflet)</h2>
            <div id="map">Initialisation de la carte...</div>
        </div>
        
        <div class="data-block">
            <h2>‚ö°Ô∏è Stats Instantan√©es</h2>
            <div class="data-row"><span class="label">Vitesse Horiz. (m/s)</span><span class="value" id="speed-raw-ms">NaN m/s (3D Brut)</span></div>
            <div class="data-row"><span class="label">Acc√©l√©ration Longitudinale (EKF)</span><span class="value" id="accel-long">NaN m/s¬≤</span></div>
            <div class="data-row"><span class="label">Force Longitudinale (en G)</span><span class="value" id="force-g-long">0.00 G</span></div>
        </div>

    </div>
    
    <script src="leaflet.js"></script>
    <script src="suncalc.js"></script>
    
    <script src="gnss-dashboard-part1.js"></script>
    <script src="gnss-dashboard-part2.js"></script>
    
    <script>
        let map, marker, polyline;
        let mapInitialized = false;

        function initMap() {
            if (mapInitialized) return;
            try {
                map = L.map('map').setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                marker = L.marker([48.8566, 2.3522]).addTo(map);
                polyline = L.polyline([], {color: 'red'}).addTo(map);
                mapInitialized = true;
                console.log("Carte Leaflet initialis√©e.");
                
                // Fonction pour mettre √† jour la carte (appel√©e dans updateDisp)
                window.updateMap = (lat, lon) => {
                    const latlng = [lat, lon];
                    marker.setLatLng(latlng);
                    polyline.addLatLng(latlng);
                    map.setView(latlng, map.getZoom() > 10 ? map.getZoom() : 13);
                };
            } catch (e) {
                console.error("Erreur lors de l'initialisation de la carte Leaflet:", e);
                document.getElementById('map').textContent = "Erreur de chargement de la carte.";
            }
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker enregistr√©. Scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('√âchec de l‚Äôenregistrement du Service Worker:', err);
                    });
            });
        }
    </script>
</body>
                </html>
